services:
  # Galera Cluster Node 1 (Bootstrap node)
  galera-node-1:
    image: mariadb:11
    container_name: galera-node-1
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: proyecto3
    command: >
      bash -c "pkill -9 rsync || true && rm -f /var/lib/mysql/rsync_sst_pid && if [ -f /var/lib/mysql/grastate.dat ]; then sed -i 's/safe_to_bootstrap: 0/safe_to_bootstrap: 1/' /var/lib/mysql/grastate.dat; fi && docker-entrypoint.sh --wsrep-new-cluster"
    volumes:
      - galera_data_1:/var/lib/mysql
      - ./galera.cnf:/etc/mysql/conf.d/galera.cnf
    networks:
      - shopping-list-network

  galera-node-2:
    image: mariadb:11
    container_name: galera-node-2
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: 123456
    volumes:
      - galera_data_2:/var/lib/mysql
      - ./galera.cnf:/etc/mysql/conf.d/galera.cnf
    networks:
      - shopping-list-network

  galera-node-3:
    image: mariadb:11
    container_name: galera-node-3
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: 123456
    volumes:
      - galera_data_3:/var/lib/mysql
      - ./galera.cnf:/etc/mysql/conf.d/galera.cnf
    networks:
      - shopping-list-network

  proxysql:
    image: proxysql/proxysql
    container_name: proxysql
    ports:
      - "6033:6033"
      - "6032:6032"
    volumes:
      - ./proxysql.cnf:/etc/proxysql.cnf
    depends_on:
      - galera-node-1
      - galera-node-2
      - galera-node-3
    networks:
      - shopping-list-network

  backend:
    build:
      context: ./back
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      DB_HOST: proxysql
      DB_PORT: 6033
      DB_USER: ${DB_USER:-root}
      DB_PASSWORD: ${DB_PASSWORD:-123456}
      DB_NAME: ${DB_NAME:-proyecto3}
      PORT: 3000
    expose:
      - "3000"

    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
      - shopping-list-network

  frontend:
    build:
      context: ./front
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://localhost:3000
        VITE_REPLICA_ID: ${HOSTNAME:-frontend}
    restart: unless-stopped
    expose:
      - "80"
    depends_on:
      - backend
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
      - shopping-list-network

  nginx-backend:
    image: nginx:alpine
    container_name: nginx-backend
    restart: unless-stopped
    volumes:
      - ./nginx-backend.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - shopping-list-network

  nginx-frontend:
    image: nginx:alpine
    container_name: nginx-frontend
    restart: unless-stopped
    volumes:
      - ./nginx-frontend.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "3001:80"
    depends_on:
      - frontend
    networks:
      - shopping-list-network

volumes:
  galera_data_1:
    driver: local
  galera_data_2:
    driver: local
  galera_data_3:
    driver: local

networks:
  shopping-list-network:
    driver: bridge
